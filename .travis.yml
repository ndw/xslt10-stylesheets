# N.B. The tokens GH_TOKEN and GITHUBTOKEN are set in the Travis setup panel
# not encrypted into this file.

language: java

jdk:
- oraclejdk8

branches:
  only:
  - master
  - travis
  - "/^release.*/"
  - "/^ndw-test.*/"

env:
  global:
  - CLASSPATH=/usr/share/java/xalan-j2.jar:/usr/share/java/xercesImpl.jar:/usr/share/java/xml-resolver.jar:$(pwd)/.travis

install:
- sudo apt-get update -q
- sudo apt-get install xsltproc
- sudo apt-get install libxml-xpath-perl
- sudo apt-get install libsaxon-java libxml-commons-resolver1.1-java libsaxon-java
  libxerces2-java
- sudo apt-get install trang
- sudo apt-get install imagemagick
- sudo apt-get install dblatex
- cp .travis/xmlc ~/.xmlc

script:
- make
- make dist
- export VERSION=$(make version)

# - make check


after_success:
- |
  if [ "$TRAVIS_REPO_SLUG" = "ndw/xslt10-stylesheets" -a \
       "$TRAVIS_PULL_REQUEST" = "false" ]; then
    export GH_TOKEN
    .travis/publish-release.sh
  fi

before_deploy:
- git config --global user.email "builds@travis-ci.com"
- git config --global user.name "Travis CI"
- export GIT_TAG=snapshot/$(date -u "+%Y-%m-%d")-$TRAVIS_BUILD_NUMBER
- git tag $GIT_TAG -a -m "Generated tag from TravisCI build $TRAVIS_BUILD_NUMBER"
- git push https://$GITHUBTOKEN@github.com/ndw/xslt10-stylesheets $GIT_TAG

notifications:
  email:
    on_success: change
    on_failure: change
  irc:
    channels:
    - chat.freenode.net#docbook

deploy:
  provider: releases
  api_key:
    secure: Ihp3feWeNFpTF8H3x3eQwusYAlXptDATl9gr/MTtfJUbtLtTMKSQSeYvg4lWjRI5mg25xS2GVwMV8QZqJe5+Ye2HlCT3b3eKUWSCpAbJHm65bpmZTawwphG+QXEnXBV9sXGiD+0ZNxFltzTv2aJIy/ZAmyo5Lba6+uRgQ622RGGaLRYRJUWTCcZpw8WOwfIAycHPk0axDyM1nswVNI3bImqFl/dTm7kVoNAM8/DLGC+dUNpXMGfREbZ5lRcdONFz3inH0DOaxCpMe5O7Dtw9awqsjS30Ejf6/W+yRui+2guW1AXdgjpmNjsZiCuiLx0zmlQCbvd88xFeSBP0W4GXE5Pdzgcn0jmU9DqB4H2161uwP0DRcrsqu5kI2Eg77GKUwFFEdzW1Xe6pcV8u1EY+juy1ozjmnQBgpgciWaqh5g0IZaUKcLvnHMCJgjTT7q/SSPVQqFUdyGW/hYJSyN2KWO2rk84ARhC5UnqDqje+m7/w84hmve9R6HsMnh14icMJvAt36ERvpT+yossJ7x9V7RStetmcXI8CGW05oFt5tnbftBtnb8kLB87SiWxxRzbYvWrEPEbfOrugt5GlYOG1gyMJpA3nPogzGvJNZx+l8Aju7w1X4x+ZAWdU8E+m/VEMqqaP1NBtpgpeDBH+7QPlDEa1WbErkIX5ya9vcNcZXWo=
  file:
  - dist/docbook-xsl-$VERSION.zip
  - dist/docbook-xsl-nons-$VERSION.zip
  - dist/docbook-xsl-doc-$VERSION.zip
  skip_cleanup: true
  on:
    tags: true
    all_branches: true
